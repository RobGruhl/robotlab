{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://robotlab.local/schemas/scene_analysis.schema.json",
  "title": "RobotLab SceneAnalysis",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "timestamp", "robot_id", "sensor_id", "camera_frame", "objects", "summary"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Semantic version of this schema.",
      "pattern": "^[0-9]+\\.[0-9]+(\\.[0-9]+)?$"
    },
    "timestamp": {
      "type": "number",
      "description": "Unix epoch time in seconds (float allowed)."
    },
    "robot_id": { "type": "string" },
    "sensor_id": { "type": "string", "description": "e.g., front_camera, drone_cam, wrist_cam" },
    "camera_frame": { "type": "string", "description": "TF frame for the camera (e.g., camera_link)" },

    "image": {
      "type": "object",
      "additionalProperties": false,
      "required": ["width", "height"],
      "properties": {
        "width": { "type": "integer", "minimum": 1 },
        "height": { "type": "integer", "minimum": 1 },
        "encoding": { "type": "string", "description": "e.g., rgb8, bgr8, mono8, jpeg" },
        "sha256": { "type": "string", "description": "Optional hash of bytes used for analysis." }
      }
    },

    "objects": {
      "type": "array",
      "description": "Detected salient objects in the scene.",
      "items": { "$ref": "#/$defs/object_detection" }
    },

    "obstacles": {
      "type": "array",
      "description": "Obstacles relevant to navigation/flight safety.",
      "items": { "$ref": "#/$defs/obstacle" },
      "default": []
    },

    "free_space": {
      "type": "object",
      "description": "Optional coarse free-space / recommended motion cue.",
      "additionalProperties": false,
      "properties": {
        "recommended_direction": {
          "type": "string",
          "enum": ["forward", "left", "right", "back", "up", "down", "hold", "unknown"]
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "relations": {
      "type": "array",
      "description": "Optional relational facts (useful for planning).",
      "items": { "$ref": "#/$defs/relation" },
      "default": []
    },

    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text", "confidence"],
      "properties": {
        "text": {
          "type": "string",
          "description": "Short scene description. Not chain-of-thought.",
          "maxLength": 600
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "warnings": {
      "type": "array",
      "description": "Model or safety warnings, e.g., low visibility, occlusion.",
      "items": { "type": "string", "maxLength": 200 },
      "default": []
    },

    "model_info": {
      "type": "object",
      "description": "Optional metadata about the model call.",
      "additionalProperties": false,
      "properties": {
        "provider": { "type": "string", "description": "e.g., anthropic, openai, google, local" },
        "model": { "type": "string" },
        "latency_ms": { "type": "number", "minimum": 0 },
        "request_id": { "type": "string" }
      }
    }
  },

  "$defs": {
    "bbox_norm": {
      "type": "object",
      "description": "Normalized bounding box in [0,1] relative to image width/height.",
      "additionalProperties": false,
      "required": ["x_min", "y_min", "x_max", "y_max"],
      "properties": {
        "x_min": { "type": "number", "minimum": 0, "maximum": 1 },
        "y_min": { "type": "number", "minimum": 0, "maximum": 1 },
        "x_max": { "type": "number", "minimum": 0, "maximum": 1 },
        "y_max": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "pose3": {
      "type": "object",
      "description": "Optional 3D pose estimate in camera_frame or a specified frame.",
      "additionalProperties": false,
      "required": ["frame_id", "position_m"],
      "properties": {
        "frame_id": { "type": "string" },
        "position_m": {
          "type": "object",
          "additionalProperties": false,
          "required": ["x", "y", "z"],
          "properties": {
            "x": { "type": "number" },
            "y": { "type": "number" },
            "z": { "type": "number" }
          }
        },
        "orientation_xyzw": {
          "type": "array",
          "description": "Quaternion [x,y,z,w] if available.",
          "items": { "type": "number" },
          "minItems": 4,
          "maxItems": 4
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "object_detection": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "label", "confidence"],
      "properties": {
        "id": { "type": "string", "description": "Stable-ish id within this observation." },
        "label": { "type": "string", "description": "Human label like 'mug', 'door', 'person'." },
        "synonyms": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },

        "bbox_norm": { "$ref": "#/$defs/bbox_norm" },

        "dominant_color": {
          "type": "string",
          "description": "Optional coarse color label (red/blue/black/...)",
          "maxLength": 40
        },

        "pose3": { "$ref": "#/$defs/pose3" },

        "attributes": {
          "type": "object",
          "description": "Extra info like 'open/closed', 'on_table', etc.",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] },
          "default": {}
        }
      }
    },

    "obstacle": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "severity", "confidence"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Obstacle category.",
          "enum": ["person", "vehicle", "wall", "furniture", "unknown", "aerial_hazard", "wire", "tree"]
        },
        "label": { "type": "string", "maxLength": 80 },
        "severity": { "type": "string", "enum": ["low", "medium", "high"] },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "region_hint": {
          "type": "string",
          "description": "Coarse region in image like 'center', 'left', 'right', 'upper', 'lower'.",
          "maxLength": 40
        },
        "bbox_norm": { "$ref": "#/$defs/bbox_norm" },
        "pose3": { "$ref": "#/$defs/pose3" }
      }
    },

    "relation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["subject_id", "predicate", "object_id", "confidence"],
      "properties": {
        "subject_id": { "type": "string" },
        "predicate": {
          "type": "string",
          "description": "E.g., 'on', 'near', 'left_of', 'right_of', 'in_front_of'.",
          "maxLength": 40
        },
        "object_id": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    }
  }
}
